<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>String Art Generator - CUDA Accelerated</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    
    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase Client (our custom file) -->
    <script src="/static/js/supabase-client.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        /* Header with User Menu */
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .user-menu {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn-header {
            padding: 8px 16px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn-header:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .btn-primary-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .btn-primary-header:hover {
            background: linear-gradient(135deg, #df82ea 0%, #e4465b 100%);
        }
        
        .user-dropdown {
            position: relative;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.6);
        }
        
        .dropdown-menu {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 250px;
            z-index: 1000;
            overflow: hidden;
        }
        
        .dropdown-header {
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .dropdown-header strong {
            display: block;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .user-email {
            display: block;
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .user-plan {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .dropdown-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 8px 0;
        }
        
        .dropdown-item {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: background 0.2s ease;
        }
        
        .dropdown-item:hover {
            background: #f5f5f5;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr 350px;
            gap: 30px;
            padding: 30px;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            height: fit-content;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .control-group input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .control-group input[type="file"]:hover {
            border-color: #764ba2;
            background: #f0f0f0;
        }
        
        .control-group input[type="number"],
        .control-group input[type="range"],
        .control-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .control-group input[type="range"] {
            padding: 0;
        }
        
        .control-group select {
            background: white;
            cursor: pointer;
        }
        
        .range-value {
            display: inline-block;
            margin-left: 10px;
            font-weight: bold;
            color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #dc3545;
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-restore {
            background: #17a2b8;
            color: white;
        }
        
        .btn-restore:hover {
            background: #138496;
            transform: translateY(-2px);
        }
        
        .btn-download {
            background: #28a745;
            color: white;
        }
        
        .btn-download:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .canvas-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* Tab Styles */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab-button {
            padding: 12px 30px;
            border: none;
            background: transparent;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-button:hover {
            color: #667eea;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .canvas-wrapper {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #stringArtCanvas, #sourceCanvas, #sequenceCanvas {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* Sequence Navigation */
        .sequence-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .nav-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .nav-btn:hover:not(:disabled) {
            background: #764ba2;
            transform: translateY(-2px);
        }
        
        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .sequence-counter {
            font-size: 1.2em;
            font-weight: 600;
            color: #667eea;
            min-width: 150px;
            text-align: center;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .progress-container {
            margin-top: 15px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 30px;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        .info-box h3 {
            margin-bottom: 10px;
            color: #856404;
        }
        
        .info-box p {
            margin: 5px 0;
            color: #856404;
        }

        .sequence-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            height: fit-content;
        }

        .sequence-panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .sequence-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .sequence-container:empty::before {
            content: 'Pin sequence will appear here...';
            color: #999;
            font-style: italic;
        }
        
        .sequence-item {
            display: inline;
            cursor: pointer;
            transition: all 0.3s;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .sequence-item:hover {
            background: #e7f3ff;
        }
        
        .sequence-item.active {
            background: #ff4444;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(255, 68, 68, 0.5);
        }

        .voice-controls {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .voice-controls h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .voice-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .voice-setting {
            display: flex;
            flex-direction: column;
        }

        .voice-setting label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
            font-size: 0.85em;
        }

        .voice-setting select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
        }

        .voice-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .voice-btn {
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .voice-btn-play {
            background: #28a745;
            color: white;
        }

        .voice-btn-play:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
        }

        .voice-btn-pause {
            background: #ffc107;
            color: #333;
        }

        .voice-btn-pause:hover:not(:disabled) {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .voice-btn-stop {
            background: #dc3545;
            color: white;
        }

        .voice-btn-stop:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
        }

        .voice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .speed-control {
            margin-top: 10px;
        }

        .speed-control label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
            font-size: 0.9em;
        }

        .current-step {
            margin-top: 10px;
            padding: 10px;
            background: #e7f3ff;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
            color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow: auto;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.5);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close-btn, .close-modal {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
            position: absolute;
            right: 20px;
            top: 15px;
            border: none;
            background: none;
        }

        .close-btn:hover, .close-modal:hover {
            color: #000;
        }

        .crop-container {
            max-height: 70vh;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #cropImage {
            max-width: 100%;
            display: block;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-footer button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
                
        .cropper-view-box,
        .cropper-face {
            border-radius: 50%;
        }
        
        .cropper-view-box {
            outline: 1px solid #667eea;
            outline-color: rgba(102, 126, 234, 0.75);
        }

        /* Image upload indicator */
        .file-indicator {
            font-size: 0.85em;
            color: #28a745;
            margin-top: 5px;
            font-style: italic;
        }

        /* ============================================================================
           AUTH & USER MENU STYLES
           ============================================================================ */
        
        /* Auth Modal Styles */
        .auth-modal-content {
            max-width: 450px;
            padding: 40px;
        }
        
        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .auth-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .auth-form h2 {
            margin: 0 0 8px 0;
            color: #333;
        }
        
        .auth-subtitle {
            color: #666;
            margin: 0 0 24px 0;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .auth-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .auth-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 16px;
        }
        
        .auth-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .auth-btn.google {
            background: white;
            border: 2px solid #e0e0e0;
            color: #333;
            margin-bottom: 10px;
        }
        
        .auth-btn.google:hover {
            border-color: #4285F4;
            background: #f8f9ff;
        }
        
        .auth-btn.github {
            background: #24292e;
            color: white;
        }
        
        .auth-btn.github:hover {
            background: #1b1f23;
        }
        
        .auth-divider {
            position: relative;
            text-align: center;
            margin: 20px 0;
        }
        
        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e0e0e0;
        }
        
        .auth-divider span {
            position: relative;
            background: white;
            padding: 0 15px;
            color: #999;
            font-size: 12px;
        }
        
        .auth-links {
            margin-top: 20px;
            text-align: center;
        }
        
        .link-btn {
            border: none;
            background: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            padding: 8px;
        }
        
        .link-btn:hover {
            text-decoration: underline;
        }
        
        .auth-terms {
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: #999;
        }
        
        .auth-terms a {
            color: #667eea;
            text-decoration: none;
        }
        
        .auth-terms a:hover {
            text-decoration: underline;
        }
        
        /* Save Design Modal */
        .save-modal-content {
            max-width: 400px;
        }
        
        .modal-subtitle {
            color: #666;
            margin: -10px 0 20px 0;
            font-size: 14px;
        }
        
        .form-status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: none;
        }
        
        .form-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .form-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn-secondary {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            color: #333;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-secondary:hover {
            border-color: #ccc;
            background: #f5f5f5;
        }
        
        /* My Designs Modal */
        .designs-modal-content {
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .designs-limit-info {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .designs-limit-info p {
            margin: 0;
            font-weight: 500;
        }
        
        .btn-upgrade {
            padding: 8px 16px;
            border: none;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }
        
        .btn-upgrade:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
        }
        
        .designs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .design-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .design-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }
        
        .design-card-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f5f5f5;
        }
        
        .design-card-content {
            padding: 16px;
        }
        
        .design-card-name {
            font-weight: 600;
            margin: 0 0 8px 0;
            font-size: 16px;
            color: #333;
        }
        
        .design-card-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .design-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .btn-small {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .btn-small:hover {
            background: #f5f5f5;
        }
        
        .btn-small.danger:hover {
            background: #fee;
            border-color: #f5576c;
            color: #f5576c;
        }
        
        .no-designs {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .no-designs p:first-child {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        /* Upgrade Modal */
        .upgrade-modal-content {
            max-width: 700px;
        }
        
        .pricing-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin: 30px 0;
        }
        
        .pricing-plan {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 32px;
            position: relative;
        }
        
        .pricing-plan.pro {
            border-color: #667eea;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
        }
        
        .popular-badge {
            position: absolute;
            top: -12px;
            right: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .pricing-plan h3 {
            margin: 0 0 16px 0;
            font-size: 24px;
        }
        
        .price {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin: 0 0 24px 0;
        }
        
        .price span {
            font-size: 16px;
            color: #999;
            font-weight: normal;
        }
        
        .pricing-plan ul {
            list-style: none;
            padding: 0;
            margin: 0 0 24px 0;
        }
        
        .pricing-plan li {
            padding: 8px 0;
            font-size: 14px;
        }
        
        .btn-large {
            padding: 14px 28px;
            font-size: 16px;
        }
        
        .upgrade-footer {
            text-align: center;
            color: #999;
            font-size: 13px;
            margin-top: 20px;
        }

        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Mobile Responsive Fixes */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-menu {
                width: 100%;
                justify-content: center;
            }
            
            .main-content {
                grid-template-columns: 1fr !important;
                padding: 15px;
                gap: 20px;
            }
            
            .controls {
                padding: 15px;
            }
            
            .control-group {
                margin-bottom: 20px;
                text-align: center;
            }
            
            .control-group label {
                text-align: center;
                display: block;
            }
            
            .control-group input[type="range"],
            .control-group select,
            .control-group input[type="file"] {
                width: 100%;
                max-width: 100%;
            }
            
            .btn {
                width: 100%;
                font-size: 1em;
                padding: 15px;
                margin-bottom: 10px;
            }
            
            .tabs {
                justify-content: center;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-button {
                padding: 10px 20px;
                font-size: 1em;
                white-space: nowrap;
            }
            
            .canvas-container {
                padding: 10px;
            }
            
            #stringArtCanvas, #sourceCanvas, #sequenceCanvas {
                max-width: 100%;
                height: auto;
                width: 100%;
            }
            
            .sequence-panel {
                padding: 15px;
            }
            
            .voice-settings {
                grid-template-columns: 1fr;
            }
            
            .voice-buttons {
                grid-template-columns: 1fr;
            }
            
            .sequence-controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
                padding: 15px;
            }
            
            /* Make crop modal better on mobile */
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 15px;
            }
            
            .crop-container {
                max-height: 60vh;
            }
            
            .modal-footer {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-footer button {
                width: 100%;
            }
            
            .pricing-comparison {
                grid-template-columns: 1fr;
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>üé® String Art Generator</h1>
                    <p>CUDA-Accelerated Nail Pattern Creation with Multilingual Voice Guidance</p>
                </div>
                
                <!-- User Menu (logged out state) -->
                <div id="userMenuLoggedOut" class="user-menu">
                    <button class="btn-header" onclick="openAuthModal('signin')">Sign In</button>
                    <button class="btn-header btn-primary-header" onclick="openAuthModal('signup')">Sign Up</button>
                </div>
                
                <!-- User Menu (logged in state) -->
                <div id="userMenuLoggedIn" class="user-menu" style="display: none;">
                    <button class="btn-header" onclick="openMyDesignsModal()">üìÅ My Designs</button>
                    <div class="user-dropdown">
                        <button class="user-avatar" onclick="toggleUserDropdown()">
                            <span id="userInitials">U</span>
                        </button>
                        <div id="userDropdownMenu" class="dropdown-menu" style="display: none;">
                            <div class="dropdown-header">
                                <strong id="userName">User</strong>
                                <span id="userEmail" class="user-email">user@example.com</span>
                                <span id="userPlan" class="user-plan">Free Plan</span>
                            </div>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" onclick="showUpgradeModal()">‚≠ê Upgrade to Pro</button>
                            <button class="dropdown-item" onclick="handleSignOut()">Sign Out</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Controls Panel -->
            <div class="controls">
                <div class="control-group">
                    <label for="imageUpload">üì§ Upload Image:</label>
                    <input type="file" id="imageUpload" accept="image/*">
                    <div id="fileIndicator" class="file-indicator" style="display: none;"></div>
                </div>
                
                <div class="control-group">
                    <label for="numNails">üìç Number of Nails: <span class="range-value" id="numNailsValue">250</span></label>
                    <input type="range" id="numNails" min="50" max="400" value="250" step="10">
                </div>
                
                <div class="control-group">
                    <label for="numStrings">üßµ Number of Strings: <span class="range-value" id="numStringsValue">4000</span></label>
                    <input type="range" id="numStrings" min="500" max="8000" value="4000" step="100">
                </div>
                
                <div class="control-group">
                    <label for="circleRadius">‚≠ï Circle Radius (cm): <span class="range-value" id="circleRadiusValue">20</span></label>
                    <input type="range" id="circleRadius" min="10" max="50" value="20" step="1">
                </div>
                
                <div class="control-group">
                    <label for="threadThickness">ü™° Thread Thickness (mm): <span class="range-value" id="threadThicknessValue">0.25</span></label>
                    <input type="range" id="threadThickness" min="0.1" max="2.0" value="0.25" step="0.05">
                </div>
                
                <div class="control-group">
                    <label for="imageResolution">üîç Image Resolution: <span class="range-value" id="imageResolutionValue">300</span></label>
                    <input type="range" id="imageResolution" min="100" max="500" value="300" step="50">
                </div>
                
                <button class="btn btn-primary" id="generateBtn" disabled>Generate Pattern</button>
                <button class="btn btn-secondary" id="cancelBtn" disabled>Cancel</button>
                <button class="btn btn-restore" id="restoreBtn" style="display: none;">üîÑ Restore Previous</button>
                <button class="btn btn-download" id="downloadTemplateBtn" disabled>üìÑ Download Template PDF</button>
                
                <!-- Save/Load Buttons (shown when logged in and has design) -->
                <button id="saveDesignBtn" class="btn btn-primary" style="display: none;" onclick="openSaveDesignModal()">üíæ Save Design</button>
                <button id="loadDesignBtn" class="btn btn-primary" style="display: none;" onclick="openMyDesignsModal()">üìÇ Load Design</button>
                
                <div class="status" id="status">Upload an image to begin</div>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                
                <div class="info-box" id="infoBox">
                    <h3>üìä Pattern Info</h3>
                    <p><strong>Total String Length:</strong> <span id="stringLength">-</span></p>
                    <p><strong>Lines Generated:</strong> <span id="linesGenerated">-</span></p>
                </div>
            </div>
            
            <!-- Canvas Area -->
            <div class="canvas-container">
                <div class="tabs">
                    <button class="tab-button active" onclick="switchTab('source')">Original Image</button>
                    <button class="tab-button" onclick="switchTab('final')">Final Pattern</button>
                </div>
                
                <div id="sourceTab" class="tab-content active">
                    <div class="canvas-wrapper">
                        <canvas id="sourceCanvas" width="800" height="800"></canvas>
                    </div>
                </div>
                
                <div id="finalTab" class="tab-content">
                    <div class="canvas-wrapper">
                        <canvas id="stringArtCanvas" width="800" height="800"></canvas>
                    </div>
                    <div class="sequence-controls">
                        <button class="nav-btn" id="prevBtn" disabled>‚Üê Previous</button>
                        <button class="nav-btn" id="replayBtn" disabled>‚ñ∂Ô∏è Replay Animation</button>
                        <button class="nav-btn" id="nextBtn" disabled>Next ‚Üí</button>
                    </div>
                    <div class="sequence-counter" id="currentStep">Ready to generate</div>
                </div>
            </div>
            
            <!-- Sequence Panel -->
            <div class="sequence-panel">
                <h2>üìù Pin Sequence</h2>
                <div class="sequence-container" id="sequenceDisplay"></div>
                
                <div class="voice-controls">
                    <h3>üé§ Voice Guidance</h3>
                    
                    <div class="voice-settings">
                        <div class="voice-setting">
                            <label for="speechMode">Mode:</label>
                            <select id="speechMode">
                                <option value="connections">Connections (From‚ÜíTo)</option>
                                <option value="numbers">Numbers Only</option>
                            </select>
                        </div>
                        
                        <div class="voice-setting">
                            <label for="voiceLanguage">Language:</label>
                            <select id="voiceLanguage">
                                <option value="en-US">English (US)</option>
                                <option value="en-GB">English (UK)</option>
                                <option value="es-ES">Spanish</option>
                                <option value="fr-FR">French</option>
                                <option value="de-DE">German</option>
                                <option value="it-IT">Italian</option>
                                <option value="pt-BR">Portuguese (BR)</option>
                                <option value="pt-PT">Portuguese (PT)</option>
                                <option value="zh-CN">Chinese (Simplified)</option>
                                <option value="ja-JP">Japanese</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="voice-buttons">
                        <button class="voice-btn voice-btn-play" id="voicePlay" disabled>‚ñ∂Ô∏è Play</button>
                        <button class="voice-btn voice-btn-pause" id="voicePause" disabled>‚è∏Ô∏è Pause</button>
                        <button class="voice-btn voice-btn-stop" id="voiceStop" disabled>‚èπÔ∏è Stop</button>
                    </div>
                    
                    <div class="speed-control">
                        <label for="voiceSpeed">Speed: <span id="speedValue">1.0x</span></label>
                        <input type="range" id="voiceSpeed" min="0.5" max="2.0" value="1.0" step="0.1">
                    </div>
                    
                    <div class="current-step" id="voiceCurrentStep">Ready to play</div>
                    
                    <canvas id="sequenceCanvas" width="300" height="300" style="display: block; margin: 20px auto; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Crop Modal -->
    <div id="cropModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úÇÔ∏è Crop Your Image</h2>
                <span class="close-btn" onclick="closeCropModal()">&times;</span>
            </div>
            
            <div class="crop-container">
                <img id="cropImage" src="" alt="Image to crop">
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCropModal()">Cancel</button>
                <button class="btn btn-primary" onclick="applyCrop()">Apply Crop</button>
            </div>
        </div>
    </div>

    <!-- ============================================================================ -->
    <!-- AUTH MODAL -->
    <!-- ============================================================================ -->
    <div id="authModal" class="modal" style="display: none;">
        <div class="modal-content auth-modal-content">
            <span class="close-modal" onclick="closeAuthModal()">&times;</span>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('signin')">Sign In</button>
                <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>
            
            <!-- Sign In Form -->
            <div id="signinForm" class="auth-form active">
                <h2>Welcome Back!</h2>
                <p class="auth-subtitle">Sign in to save and manage your designs</p>
                
                <form onsubmit="handleSignIn(event)">
                    <div class="form-group">
                        <label for="signinEmail">Email</label>
                        <input type="email" id="signinEmail" required placeholder="you@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="signinPassword">Password</label>
                        <input type="password" id="signinPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <button type="submit" class="auth-btn primary">Sign In</button>
                    
                    <div class="auth-divider">
                        <span>OR</span>
                    </div>
                    
                    <button type="button" class="auth-btn google" onclick="handleOAuthSignIn('google')">
                        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/></svg>
                        Continue with Google
                    </button>
                    
                    <button type="button" class="auth-btn github" onclick="handleOAuthSignIn('github')">
                        <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
                        Continue with GitHub
                    </button>
                    
                    <div class="auth-links">
                        <button type="button" class="link-btn" onclick="switchAuthTab('magic')">Sign in with magic link</button>
                        <button type="button" class="link-btn" onclick="switchAuthTab('reset')">Forgot password?</button>
                    </div>
                </form>
            </div>
            
            <!-- Sign Up Form -->
            <div id="signupForm" class="auth-form">
                <h2>Create Account</h2>
                <p class="auth-subtitle">Start saving your amazing designs!</p>
                
                <form onsubmit="handleSignUp(event)">
                    <div class="form-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" required placeholder="John Doe">
                    </div>
                    
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" required placeholder="you@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" required minlength="6" placeholder="At least 6 characters">
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPasswordConfirm">Confirm Password</label>
                        <input type="password" id="signupPasswordConfirm" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <button type="submit" class="auth-btn primary">Create Account</button>
                    
                    <div class="auth-divider">
                        <span>OR</span>
                    </div>
                    
                    <button type="button" class="auth-btn google" onclick="handleOAuthSignIn('google')">
                        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/></svg>
                        Sign up with Google
                    </button>
                    
                    <button type="button" class="auth-btn github" onclick="handleOAuthSignIn('github')">
                        <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
                        Sign up with GitHub
                    </button>
                    
                    <p class="auth-terms">By signing up, you agree to our <a href="#">Terms</a> and <a href="#">Privacy Policy</a></p>
                </form>
            </div>
            
            <!-- Magic Link Form -->
            <div id="magicForm" class="auth-form">
                <h2>Magic Link</h2>
                <p class="auth-subtitle">We'll email you a link to sign in</p>
                
                <form onsubmit="handleMagicLink(event)">
                    <div class="form-group">
                        <label for="magicEmail">Email</label>
                        <input type="email" id="magicEmail" required placeholder="you@example.com">
                    </div>
                    
                    <button type="submit" class="auth-btn primary">Send Magic Link</button>
                    
                    <div class="auth-links">
                        <button type="button" class="link-btn" onclick="switchAuthTab('signin')">‚Üê Back to sign in</button>
                    </div>
                </form>
            </div>
            
            <!-- Password Reset Form -->
            <div id="resetForm" class="auth-form">
                <h2>Reset Password</h2>
                <p class="auth-subtitle">We'll send you a password reset link</p>
                
                <form onsubmit="handlePasswordReset(event)">
                    <div class="form-group">
                        <label for="resetEmail">Email</label>
                        <input type="email" id="resetEmail" required placeholder="you@example.com">
                    </div>
                    
                    <button type="submit" class="auth-btn primary">Send Reset Link</button>
                    
                    <div class="auth-links">
                        <button type="button" class="link-btn" onclick="switchAuthTab('signin')">‚Üê Back to sign in</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ============================================================================ -->
    <!-- SAVE DESIGN MODAL -->
    <!-- ============================================================================ -->
    <div id="saveDesignModal" class="modal" style="display: none;">
        <div class="modal-content save-modal-content">
            <span class="close-modal" onclick="closeSaveDesignModal()">&times;</span>
            
            <h2>üíæ Save Design</h2>
            <p class="modal-subtitle">Give your design a name</p>
            
            <form onsubmit="handleSaveDesign(event)">
                <div class="form-group">
                    <label for="designName">Design Name</label>
                    <input type="text" id="designName" required placeholder="e.g., Mom's Portrait" maxlength="100">
                </div>
                
                <div id="saveDesignStatus" class="form-status"></div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeSaveDesignModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Design</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================================================ -->
    <!-- MY DESIGNS MODAL -->
    <!-- ============================================================================ -->
    <div id="myDesignsModal" class="modal" style="display: none;">
        <div class="modal-content designs-modal-content">
            <span class="close-modal" onclick="closeMyDesignsModal()">&times;</span>
            
            <h2>üìÅ My Designs</h2>
            
            <div id="designsLimitInfo" class="designs-limit-info" style="display: none;">
                <p>üéÅ Free plan: <span id="designCount">0</span>/3 designs saved</p>
                <button class="btn-upgrade" onclick="showUpgradeModal()">‚≠ê Upgrade to Pro for Unlimited</button>
            </div>
            
            <div id="designsGrid" class="designs-grid">
                <!-- Designs will be populated here -->
            </div>
            
            <div id="noDesigns" class="no-designs" style="display: none;">
                <p>üì≠ No saved designs yet</p>
                <p>Generate and save your first string art design!</p>
            </div>
        </div>
    </div>

    <!-- ============================================================================ -->
    <!-- UPGRADE MODAL -->
    <!-- ============================================================================ -->
    <div id="upgradeModal" class="modal" style="display: none;">
        <div class="modal-content upgrade-modal-content">
            <span class="close-modal" onclick="closeUpgradeModal()">&times;</span>
            
            <h2>‚≠ê Upgrade to Pro</h2>
            
            <div class="pricing-comparison">
                <div class="pricing-plan free">
                    <h3>Free</h3>
                    <p class="price">$0</p>
                    <ul>
                        <li>‚úÖ Unlimited generations</li>
                        <li>‚úÖ Save up to 3 designs</li>
                        <li>‚úÖ Basic resolution</li>
                        <li>‚ö†Ô∏è Small watermark</li>
                    </ul>
                </div>
                
                <div class="pricing-plan pro">
                    <div class="popular-badge">Most Popular</div>
                    <h3>Pro</h3>
                    <p class="price">$9.99<span>/month</span></p>
                    <ul>
                        <li>‚úÖ Everything in Free</li>
                        <li>‚≠ê Unlimited saved designs</li>
                        <li>‚≠ê High-resolution exports</li>
                        <li>‚≠ê No watermarks</li>
                        <li>‚≠ê Priority GPU access</li>
                        <li>‚≠ê Commercial usage rights</li>
                    </ul>
                    <button class="btn btn-primary btn-large" onclick="handleUpgrade()">Upgrade Now</button>
                </div>
            </div>
            
            <p class="upgrade-footer">Cancel anytime. 30-day money-back guarantee.</p>
        </div>
    </div>
 <script>
        // ============================================================================
        // GLOBAL VARIABLES & INITIALIZATION
        // ============================================================================
        
        const socket = io();
        const canvas = document.getElementById('stringArtCanvas');
        const ctx = canvas.getContext('2d');
        const sourceCanvas = document.getElementById('sourceCanvas');
        const sourceCtx = sourceCanvas.getContext('2d');
        const sequenceCanvas = document.getElementById('sequenceCanvas');
        const sequenceCtx = sequenceCanvas.getContext('2d');
        
        const imageUpload = document.getElementById('imageUpload');
        const generateBtn = document.getElementById('generateBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const restoreBtn = document.getElementById('restoreBtn');
        const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
        const status = document.getElementById('status');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const infoBox = document.getElementById('infoBox');
        const fileIndicator = document.getElementById('fileIndicator');
        
        const replayBtn = document.getElementById('replayBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        const voicePlay = document.getElementById('voicePlay');
        const voicePause = document.getElementById('voicePause');
        const voiceStop = document.getElementById('voiceStop');
        const voiceSpeed = document.getElementById('voiceSpeed');
        const speedValue = document.getElementById('speedValue');
        const speechMode = document.getElementById('speechMode');
        const voiceLanguage = document.getElementById('voiceLanguage');
        const voiceCurrentStep = document.getElementById('voiceCurrentStep');
        
        let pinSequence = [];
        let numNails = 250;
        let circleRadius = 20;
        let isGenerating = false;
        let cropper = null;
        let currentImageFile = null;
        let currentImageData = null;
        let animationFrameId = null;
        let hasValidCanvasData = false;
        let animationAlreadyPlayed = false;
        
        let voiceIndex = 0;
        let voiceInterval = null;
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        
        let lastGenerationProvider = null;
        let lastGenerationTime = null;
        
        // Calculate visual line width based on physical parameters
        function calculateLineWidth(threadThicknessMm, circleRadiusCm) {
            const CANVAS_RADIUS = 390; // pixels (matches the drawing radius)
            const threadThicknessCm = threadThicknessMm / 10; // Convert mm to cm
            const proportionalThickness = threadThicknessCm / circleRadiusCm;
            const visualWidth = proportionalThickness * CANVAS_RADIUS;
            
            // Clamp between 0.1 and 5 pixels for visibility and performance
            return Math.max(0.1, Math.min(5, visualWidth));
        }
        
        // ============================================================================
        // RANGE INPUT HANDLERS
        // ============================================================================
        
        document.getElementById('numNails').addEventListener('input', (e) => {
            document.getElementById('numNailsValue').textContent = e.target.value;
        });
        
        document.getElementById('numStrings').addEventListener('input', (e) => {
            document.getElementById('numStringsValue').textContent = e.target.value;
        });
        
        document.getElementById('circleRadius').addEventListener('input', (e) => {
            document.getElementById('circleRadiusValue').textContent = e.target.value;
        });
        
        document.getElementById('threadThickness').addEventListener('input', (e) => {
            document.getElementById('threadThicknessValue').textContent = e.target.value;
        });
        
        document.getElementById('imageResolution').addEventListener('input', (e) => {
            document.getElementById('imageResolutionValue').textContent = e.target.value;
        });
        
        voiceSpeed.addEventListener('input', (e) => {
            speedValue.textContent = e.target.value + 'x';
        });
        
        speechMode.addEventListener('change', () => {
            updateSpeechModeExamples();
        });
        
        // ============================================================================
        // IMAGE UPLOAD & CROPPING
        // ============================================================================
        
        imageUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                currentImageFile = file;
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        document.getElementById('cropImage').src = event.target.result;
                        openCropModal();
                        fileIndicator.textContent = `üìÅ ${file.name}`;
                        fileIndicator.style.display = 'block';
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        function openCropModal() {
            const modal = document.getElementById('cropModal');
            const image = document.getElementById('cropImage');
            modal.style.display = 'flex';
            
            if (cropper) {
                cropper.destroy();
            }
            
            cropper = new Cropper(image, {
                aspectRatio: 1,
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 0.9,
                restore: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
            });
        }
        
        function closeCropModal() {
            const modal = document.getElementById('cropModal');
            modal.style.display = 'none';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }
        
        function applyCrop() {
            if (cropper) {
                const croppedCanvas = cropper.getCroppedCanvas({
                    width: 800,
                    height: 800
                });
                
                sourceCtx.clearRect(0, 0, sourceCanvas.width, sourceCanvas.height);
                sourceCtx.drawImage(croppedCanvas, 0, 0);
                
                croppedCanvas.toBlob(function(blob) {
                    currentImageData = croppedCanvas.toDataURL('image/png');
                    generateBtn.disabled = false;
                    status.textContent = '‚úÖ Image ready! Click Generate Pattern';
                    switchTab('source');
                });
                
                closeCropModal();
            }
        }
        
        // ============================================================================
        // TAB SWITCHING
        // ============================================================================
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            if (tabName === 'source') {
                document.getElementById('sourceTab').classList.add('active');
                document.querySelectorAll('.tab-button')[0].classList.add('active');
            } else if (tabName === 'final') {
                document.getElementById('finalTab').classList.add('active');
                document.querySelectorAll('.tab-button')[1].classList.add('active');
            }
        }
        
        // ============================================================================
        // PATTERN GENERATION
        // ============================================================================
        
        generateBtn.addEventListener('click', function() {
            if (!currentImageData) {
                status.textContent = '‚ùå Please upload and crop an image first';
                return;
            }
            
            isGenerating = true;
            generateBtn.disabled = true;
            cancelBtn.disabled = false;
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            status.textContent = 'üöÄ Starting generation...';
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            pinSequence = [];
            document.getElementById('sequenceDisplay').innerHTML = '';
            animationAlreadyPlayed = false;
            
            const params = {
                num_nails: parseInt(document.getElementById('numNails').value),
                num_strings: parseInt(document.getElementById('numStrings').value),
                image_resolution: parseInt(document.getElementById('imageResolution').value),
                circle_radius_cm: parseFloat(document.getElementById('circleRadius').value),
                thread_thickness_mm: parseFloat(document.getElementById('threadThickness').value)
            };
            
            socket.emit('start_generation', {
                imageData: currentImageData,
                params: params
            });
        });
        
        cancelBtn.addEventListener('click', function() {
            socket.emit('cancel_generation');
            status.textContent = 'üõë Cancelling...';
            cancelBtn.disabled = true;
        });
        
        // ============================================================================
        // SOCKET.IO EVENT HANDLERS
        // ============================================================================
        
        socket.on('connect', () => {
            console.log('‚úÖ Connected to server');
        });
        
        socket.on('status', (data) => {
            status.textContent = data.msg;
        });
        
        socket.on('progress', (data) => {
            const percent = Math.round(data.percent);
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
        });
        
        socket.on('new_line', (data) => {
            if (isGenerating && pinSequence.length === 0) {
                animationAlreadyPlayed = true;
                const startNail = data.start;
                const endNail = data.end;
                
                if (startNail >= 0 && startNail < numNails && 
                    endNail >= 0 && endNail < numNails) {
                    const startPos = getDrawPosition(startNail, numNails);
                    const endPos = getDrawPosition(endNail, numNails);
                    
                    // Calculate line width based on physical parameters
                    const threadThickness = parseFloat(document.getElementById('threadThickness').value);
                    const circleRadius = parseFloat(document.getElementById('circleRadius').value);
                    
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                    ctx.lineWidth = calculateLineWidth(threadThickness, circleRadius);
                    ctx.beginPath();
                    ctx.moveTo(startPos.x, startPos.y);
                    ctx.lineTo(endPos.x, endPos.y);
                    ctx.stroke();
                }
            }
        });
        
        socket.on('final_sequence', (data) => {
            if (data.status !== 'success') {
                console.error("Received non-success status:", data); 
                status.textContent = `‚ùå GPU Error: ${data.message || 'Unknown error'}`;
                isGenerating = false; 
                generateBtn.disabled = false;
                cancelBtn.disabled = true; 
                progressContainer.style.display = 'none'; 
                return; 
            }
            
            isGenerating = false; 
            generateBtn.disabled = false;
            cancelBtn.disabled = false; 
            downloadTemplateBtn.disabled = false; 
            hasValidCanvasData = false; 
            
            pinSequence = data.sequence; 
            const physicalInfo = data.physical_info; 
            numNails = physicalInfo.num_nails; 
            circleRadius = physicalInfo.radius_cm;
            
            document.getElementById('numNails').value = numNails; 
            document.getElementById('numNailsValue').textContent = numNails;
            document.getElementById('circleRadius').value = circleRadius; 
            document.getElementById('circleRadiusValue').textContent = circleRadius;
            voiceIndex = 0;
            
            // Track metadata for saving
            if (data.provider) {
                lastGenerationProvider = data.provider;
            }
            if (data.total_time) {
                lastGenerationTime = data.total_time * 1000;
            }
            
            // Only animate if it wasn't already drawn in real-time
            if (!animationAlreadyPlayed) {
                // RunPod path - animate now
                animateDrawing(pinSequence, numNails);
            } else {
                // Home GPU path - animation already happened in real-time
                // Just draw the final result immediately
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawCircle(numNails);
                
                // Calculate line width based on physical parameters
                const threadThickness = parseFloat(document.getElementById('threadThickness').value);
                const circleRadius = parseFloat(document.getElementById('circleRadius').value);
                
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                ctx.lineWidth = calculateLineWidth(threadThickness, circleRadius);
                
                for (let i = 0; i < pinSequence.length - 1; i++) {
                    const startNail = pinSequence[i] - 1;
                    const endNail = pinSequence[i + 1] - 1;
                    if (startNail < 0 || startNail >= numNails || endNail < 0 || endNail >= numNails) continue;
                    
                    const startPos = getDrawPosition(startNail, numNails);
                    const endPos = getDrawPosition(endNail, numNails);
                    ctx.beginPath();
                    ctx.moveTo(startPos.x, startPos.y);
                    ctx.lineTo(endPos.x, endPos.y);
                    ctx.stroke();
                }
                
                status.textContent = '‚úÖ Pattern complete!';
                hasValidCanvasData = true;
                saveState();
            }
            
            // Reset flag for next generation
            animationAlreadyPlayed = false; 
            
            renderSequence(); 
            updateSpeechModeExamples(); 
            updateSequenceNavigation(); 
            
            voicePlay.disabled = false; 
            voiceStop.disabled = false; 
            replayBtn.disabled = false;
            prevBtn.disabled = true; 
            nextBtn.disabled = pinSequence.length <= 1;
            currentStep.textContent = 'Ready to play';
            
            document.getElementById('stringLength').textContent = `${physicalInfo.total_length_m.toFixed(2)} m (approx ${(physicalInfo.total_length_m * 3.28084).toFixed(1)} ft)`;
            document.getElementById('linesGenerated').textContent = physicalInfo.num_lines;
            infoBox.style.display = 'block';
        });
        
        socket.on('generation_stopped', () => {
            isGenerating = false;
            generateBtn.disabled = false;
            cancelBtn.disabled = true;
            status.textContent = 'üõë Generation cancelled';
            progressContainer.style.display = 'none';
        });
        
        // ============================================================================
        // DRAWING FUNCTIONS
        // ============================================================================
        
        function getDrawPosition(nailIndex, totalNails) { 
            const centerX = 400;
            const centerY = 400;
            const radius = 390; 
            const angle = (nailIndex / totalNails) * 2 * Math.PI;
            return {
                x: centerX + radius * Math.cos(angle),
                y: centerY + radius * Math.sin(angle)
            };
        }
        
        function drawCircle(nailsToDraw) { 
            const centerX = 400;
            const centerY = 400;
            const radius = 390; 
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.stroke();
            ctx.fillStyle = '#666';
            for (let i = 0; i < nailsToDraw; i++) { 
                const angle = (i / nailsToDraw) * 2 * Math.PI; 
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                ctx.beginPath();
                ctx.arc(x, y, 2, 0, 2 * Math.PI);
                ctx.fill();
            }
        }
        
        function animateDrawing(sequence, currentNumNails) {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawCircle(currentNumNails);
            
            // Calculate line width based on physical parameters
            const threadThickness = parseFloat(document.getElementById('threadThickness').value);
            const circleRadius = parseFloat(document.getElementById('circleRadius').value);
            
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.lineWidth = calculateLineWidth(threadThickness, circleRadius);
            
            let i = 0;
            const linesPerFrame = 10; 
            
            function drawStep() {
                const end = Math.min(i + linesPerFrame, sequence.length - 1);
                for (; i < end; i++) {
                    const startNail = sequence[i] - 1;
                    const endNail = sequence[i + 1] - 1;
                    if (startNail < 0 || startNail >= currentNumNails || 
                        endNail < 0 || endNail >= currentNumNails) {
                        console.error(`Invalid nail index`);
                        continue; 
                    }
                    const startPos = getDrawPosition(startNail, currentNumNails);
                    const endPos = getDrawPosition(endNail, currentNumNails);
                    ctx.beginPath();
                    ctx.moveTo(startPos.x, startPos.y);
                    ctx.lineTo(endPos.x, endPos.y);
                    ctx.stroke();
                }
                if (i < sequence.length - 1) {
                    animationFrameId = requestAnimationFrame(drawStep); 
                } else {
                    hasValidCanvasData = true;
                    animationFrameId = null;
                    saveState();
                }
            }
            animationFrameId = requestAnimationFrame(drawStep);
        }
        
        // ============================================================================
        // SEQUENCE DISPLAY
        // ============================================================================
        
        function renderSequence() {
            const container = document.getElementById('sequenceDisplay');
            container.innerHTML = '';
            
            pinSequence.forEach((pin, index) => {
                const span = document.createElement('span');
                span.className = 'sequence-item';
                span.textContent = pin;
                span.onclick = () => jumpToStep(index);
                
                container.appendChild(span);
                
                if (index < pinSequence.length - 1) {
                    const separator = document.createTextNode(' ‚Üí ');
                    container.appendChild(separator);
                }
            });
        }
        
        function jumpToStep(index) {
            voiceIndex = index;
            updateSequenceNavigation();
            drawSequenceVisualization(index, numNails);
        }
        
        // ============================================================================
        // SEQUENCE NAVIGATION
        // ============================================================================
        
        replayBtn.addEventListener('click', () => {
            if (pinSequence.length > 0) {
                animateDrawing(pinSequence, numNails);
                switchTab('final');
            }
        });
        
        prevBtn.addEventListener('click', () => {
            if (voiceIndex > 0) {
                voiceIndex--;
                updateSequenceNavigation();
                drawSequenceVisualization(voiceIndex, numNails);
            }
        });
        
        nextBtn.addEventListener('click', () => {
            if (voiceIndex < pinSequence.length - 1) {
                voiceIndex++;
                updateSequenceNavigation();
                drawSequenceVisualization(voiceIndex, numNails);
            }
        });
        
        function updateSequenceNavigation() {
            prevBtn.disabled = voiceIndex <= 0;
            nextBtn.disabled = voiceIndex >= pinSequence.length - 1;
            
            const mode = speechMode.value;
            if (mode === 'connections') {
                currentStep.textContent = `Step ${voiceIndex + 1} of ${pinSequence.length - 1}`;
            } else {
                currentStep.textContent = `Pin ${voiceIndex + 1} of ${pinSequence.length}`;
            }
            
            document.querySelectorAll('.sequence-item').forEach((item, index) => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelectorAll('.sequence-item')[voiceIndex];
            if (activeItem) {
                activeItem.classList.add('active');
                activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function drawSequenceVisualization(index, sequenceNumNails) { 
            if (pinSequence.length === 0) return;
            
            const mode = speechMode.value;
            const currentNumNails = sequenceNumNails || numNails;

            sequenceCtx.clearRect(0, 0, sequenceCanvas.width, sequenceCanvas.height);
            
            const centerX = sequenceCanvas.width / 2;
            const centerY = sequenceCanvas.height / 2;
            const radius = sequenceCanvas.width / 2 - 60;
            
            sequenceCtx.strokeStyle = '#ddd';
            sequenceCtx.lineWidth = 2;
            sequenceCtx.beginPath();
            sequenceCtx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            sequenceCtx.stroke();
            
            function getSequenceNailPos(nailIndex) {
                const angle = (nailIndex / currentNumNails) * 2 * Math.PI; 
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                return { x, y, angle };
            }

            // Highlight current connection/pin
            if (mode === 'connections' && index < pinSequence.length - 1) {
                const fromNail = pinSequence[index] - 1;
                const toNail = pinSequence[index + 1] - 1;
                
                const fromPos = getSequenceNailPos(fromNail);
                const toPos = getSequenceNailPos(toNail);
                
                // Calculate line width based on physical parameters
                const threadThickness = parseFloat(document.getElementById('threadThickness').value);
                const circleRadius = parseFloat(document.getElementById('circleRadius').value);
                
                sequenceCtx.strokeStyle = '#000';
                sequenceCtx.lineWidth = calculateLineWidth(threadThickness, circleRadius);
                sequenceCtx.beginPath();
                sequenceCtx.moveTo(fromPos.x, fromPos.y);
                sequenceCtx.lineTo(toPos.x, toPos.y);
                sequenceCtx.stroke();
                
                sequenceCtx.fillStyle = '#667eea';
                sequenceCtx.beginPath();
                sequenceCtx.arc(fromPos.x, fromPos.y, 12, 0, 2 * Math.PI);
                sequenceCtx.fill();
                
                sequenceCtx.fillStyle = '#764ba2';
                sequenceCtx.beginPath();
                sequenceCtx.arc(toPos.x, toPos.y, 12, 0, 2 * Math.PI);
                sequenceCtx.fill();
                
                sequenceCtx.fillStyle = '#fff';
                sequenceCtx.font = 'bold 12px Arial';
                sequenceCtx.textAlign = 'center';
                sequenceCtx.textBaseline = 'middle';
                sequenceCtx.fillText(pinSequence[index], fromPos.x, fromPos.y);
                sequenceCtx.fillText(pinSequence[index + 1], toPos.x, toPos.y);
                
                const labelRadius = radius + 40;
                const fromLabelX = centerX + labelRadius * Math.cos(fromPos.angle);
                const fromLabelY = centerY + labelRadius * Math.sin(fromPos.angle);
                const toLabelX = centerX + labelRadius * Math.cos(toPos.angle);
                const toLabelY = centerY + labelRadius * Math.sin(toPos.angle);
                
                sequenceCtx.fillStyle = '#000';
                sequenceCtx.font = 'bold 16px Arial';
                sequenceCtx.fillText(`FROM ${pinSequence[index]}`, fromLabelX, fromLabelY);
                sequenceCtx.fillText(`TO ${pinSequence[index + 1]}`, toLabelX, toLabelY);
                
            } else if (mode === 'numbers' && index < pinSequence.length) {
                const nail = pinSequence[index] - 1;
                const pos = getSequenceNailPos(nail);
                
                sequenceCtx.fillStyle = '#ff4444';
                sequenceCtx.beginPath();
                sequenceCtx.arc(pos.x, pos.y, 15, 0, 2 * Math.PI);
                sequenceCtx.fill();
                
                sequenceCtx.fillStyle = '#fff';
                sequenceCtx.font = 'bold 14px Arial';
                sequenceCtx.textAlign = 'center';
                sequenceCtx.textBaseline = 'middle';
                sequenceCtx.fillText(pinSequence[index], pos.x, pos.y);
                
                const labelRadius = radius + 40;
                const labelX = centerX + labelRadius * Math.cos(pos.angle);
                const labelY = centerY + labelRadius * Math.sin(pos.angle);
                
                sequenceCtx.fillStyle = '#000';
                sequenceCtx.font = 'bold 18px Arial';
                sequenceCtx.fillText(`PIN ${pinSequence[index]}`, labelX, labelY);
            }
        }
        
        // ============================================================================
        // VOICE GUIDANCE
        // ============================================================================
        
        voicePlay.addEventListener('click', startVoiceGuidance);
        voicePause.addEventListener('click', pauseVoiceGuidance);
        voiceStop.addEventListener('click', stopVoiceGuidance);
        
        function startVoiceGuidance() {
            if (pinSequence.length === 0) return;
            
            voicePlay.disabled = true;
            voicePause.disabled = false;
            voiceStop.disabled = false;
            
            const mode = speechMode.value;
            const speed = parseFloat(voiceSpeed.value);
            
            if (voiceInterval) {
                clearInterval(voiceInterval);
            }
            
            voiceInterval = setInterval(() => {
                if (speechSynthesis.speaking) {
                    return;
                }
                
                if ((mode === 'connections' && voiceIndex >= pinSequence.length - 1) ||
                    (mode === 'numbers' && voiceIndex >= pinSequence.length)) {
                    stopVoiceGuidance();
                    return;
                }
                
                speakCurrentStep(speed);
                drawSequenceVisualization(voiceIndex, numNails);
                updateSequenceNavigation();
                
                voiceIndex++;
            }, 100);
        }
        
        function pauseVoiceGuidance() {
            if (voiceInterval) {
                clearInterval(voiceInterval);
                voiceInterval = null;
            }
            speechSynthesis.cancel();
            voicePlay.disabled = false;
            voicePause.disabled = true;
        }
        
        function stopVoiceGuidance() {
            if (voiceInterval) {
                clearInterval(voiceInterval);
                voiceInterval = null;
            }
            speechSynthesis.cancel();
            voiceIndex = 0;
            voicePlay.disabled = false;
            voicePause.disabled = true;
            voiceStop.disabled = true;
            voiceCurrentStep.textContent = 'Ready to play';
            updateSequenceNavigation();
            drawSequenceVisualization(0, numNails);
        }
        
        function speakCurrentStep(speed) {
            const mode = speechMode.value;
            const lang = voiceLanguage.value;
            
            let text = '';
            
            if (mode === 'connections') {
                if (voiceIndex < pinSequence.length - 1) {
                    const from = pinSequence[voiceIndex];
                    const to = pinSequence[voiceIndex + 1];
                    text = getLocalizedConnectionText(from, to, lang);
                    voiceCurrentStep.textContent = `From ${from} to ${to}`;
                }
            } else {
                if (voiceIndex < pinSequence.length) {
                    const pin = pinSequence[voiceIndex];
                    text = getLocalizedNumberText(pin, lang);
                    voiceCurrentStep.textContent = `Pin ${pin}`;
                }
            }
            
            if (text) {
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.rate = speed;
                currentUtterance.lang = lang;
                speechSynthesis.speak(currentUtterance);
            }
        }
        
        function getLocalizedConnectionText(from, to, lang) {
            const templates = {
                'en-US': `From ${from} to ${to}`,
                'en-GB': `From ${from} to ${to}`,
                'es-ES': `De ${from} a ${to}`,
                'fr-FR': `De ${from} √† ${to}`,
                'de-DE': `Von ${from} zu ${to}`,
                'it-IT': `Da ${from} a ${to}`,
                'pt-BR': `De ${from} para ${to}`,
                'pt-PT': `De ${from} para ${to}`,
                'zh-CN': `‰ªé ${from} Âà∞ ${to}`,
                'ja-JP': `${from} „Åã„Çâ ${to} „Å∏`
            };
            return templates[lang] || templates['en-US'];
        }
        
        function getLocalizedNumberText(num, lang) {
            const templates = {
                'en-US': `${num}`,
                'en-GB': `${num}`,
                'es-ES': `${num}`,
                'fr-FR': `${num}`,
                'de-DE': `${num}`,
                'it-IT': `${num}`,
                'pt-BR': `${num}`,
                'pt-PT': `${num}`,
                'zh-CN': `${num}`,
                'ja-JP': `${num}`
            };
            return templates[lang] || `${num}`;
        }
        
        function updateSpeechModeExamples() {
            if (pinSequence.length >= 2) {
                const lang = voiceLanguage.value;
                const mode = speechMode.value;
                
                if (mode === 'connections') {
                    const example = getLocalizedConnectionText(pinSequence[0], pinSequence[1], lang);
                    voiceCurrentStep.textContent = `Example: "${example}"`;
                } else {
                    const example = getLocalizedNumberText(pinSequence[0], lang);
                    voiceCurrentStep.textContent = `Example: "${example}"`;
                }
            }
        }
        
        // ============================================================================
        // STATE MANAGEMENT
        // ============================================================================
        
        function saveState() {
            if (hasValidCanvasData && pinSequence.length > 0) {
                const state = {
                    pinSequence: pinSequence,
                    numNails: numNails,
                    circleRadius: circleRadius,
                    canvasImage: canvas.toDataURL(),
                    sourceImage: currentImageData,
                    timestamp: Date.now()
                };
                localStorage.setItem('stringArtState', JSON.stringify(state));
                restoreBtn.style.display = 'block';
            }
        }
        
        function loadState() {
            const saved = localStorage.getItem('stringArtState');
            if (saved) {
                const state = JSON.parse(saved);
                pinSequence = state.pinSequence;
                numNails = state.numNails;
                circleRadius = state.circleRadius;
                currentImageData = state.sourceImage;
                
                const img = new Image();
                img.onload = () => {
                    sourceCtx.clearRect(0, 0, sourceCanvas.width, sourceCanvas.height);
                    sourceCtx.drawImage(img, 0, 0);
                    
                    const canvasImg = new Image();
                    canvasImg.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(canvasImg, 0, 0);
                        hasValidCanvasData = true;
                        
                        renderSequence();
                        updateSpeechModeExamples();
                        updateSequenceNavigation();
                        
                        generateBtn.disabled = false;
                        replayBtn.disabled = false;
                        voicePlay.disabled = false;
                        voiceStop.disabled = false;
                        downloadTemplateBtn.disabled = false;
                        nextBtn.disabled = pinSequence.length <= 1;
                        
                        status.textContent = 'üîÑ Previous session restored!';
                        restoreBtn.style.display = 'none';
                    };
                    canvasImg.src = state.canvasImage;
                };
                img.src = state.sourceImage;
            }
        }
        
        restoreBtn.addEventListener('click', loadState);
        
        // Check for saved state on load
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('stringArtState');
            if (saved) {
                restoreBtn.style.display = 'block';
            }
        });
        
        // ============================================================================
        // TEMPLATE DOWNLOAD
        // ============================================================================
        
        downloadTemplateBtn.addEventListener('click', () => {
            if (pinSequence.length === 0) {
                alert('No pattern generated yet!');
                return;
            }
            
            const currentNumNails = parseInt(document.getElementById('numNails').value);
            const currentRadius = parseFloat(document.getElementById('circleRadius').value);
            
            window.location.href = `/download_template/${currentNumNails}/${currentRadius}`;
        });
        
        // ============================================================================
        // AUTHENTICATION EVENT HANDLERS
        // ============================================================================
        
        function openAuthModal(tab = 'signin') {
            document.getElementById('authModal').style.display = 'flex';
            switchAuthTab(tab);
        }
        
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }
        
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });
            
            document.querySelectorAll('.auth-tab').forEach(t => {
                t.classList.remove('active');
            });
            
            if (tab === 'signin') {
                document.getElementById('signinForm').classList.add('active');
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
            } else if (tab === 'signup') {
                document.getElementById('signupForm').classList.add('active');
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
            } else if (tab === 'magic') {
                document.getElementById('magicForm').classList.add('active');
            } else if (tab === 'reset') {
                document.getElementById('resetForm').classList.add('active');
            }
        }
        
        async function handleSignIn(event) {
            event.preventDefault();
            
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;
            
            const result = await window.SupabaseAuth.signIn(email, password);
            
            if (result.success) {
                closeAuthModal();
                showNotification('‚úÖ Signed in successfully!', 'success');
            } else {
                showNotification('‚ùå ' + result.error, 'error');
            }
        }
        
        async function handleSignUp(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupPasswordConfirm').value;
            
            if (password !== confirmPassword) {
                showNotification('‚ùå Passwords do not match', 'error');
                return;
            }
            
            const result = await window.SupabaseAuth.signUp(email, password, name);
            
            if (result.success) {
                closeAuthModal();
                showNotification('‚úÖ Account created! Please check your email to verify.', 'success');
            } else {
                showNotification('‚ùå ' + result.error, 'error');
            }
        }
        
        async function handleMagicLink(event) {
            event.preventDefault();
            
            const email = document.getElementById('magicEmail').value;
            
            const result = await window.SupabaseAuth.signInWithMagicLink(email);
            
            if (result.success) {
                closeAuthModal();
                showNotification('‚úÖ Magic link sent! Check your email.', 'success');
            } else {
                showNotification('‚ùå ' + result.error, 'error');
            }
        }
        
        async function handlePasswordReset(event) {
            event.preventDefault();
            
            const email = document.getElementById('resetEmail').value;
            
            const result = await window.SupabaseAuth.resetPassword(email);
            
            if (result.success) {
                closeAuthModal();
                showNotification('‚úÖ Password reset link sent! Check your email.', 'success');
            } else {
                showNotification('‚ùå ' + result.error, 'error');
            }
        }
        
        async function handleOAuthSignIn(provider) {
            const result = await window.SupabaseAuth.signInWithOAuth(provider);
            
            if (!result.success) {
                showNotification('‚ùå ' + result.error, 'error');
            }
        }
        
        async function handleSignOut() {
            const result = await window.SupabaseAuth.signOut();
            
            if (result.success) {
                showNotification('üëã Signed out successfully', 'success');
                closeUserDropdown();
            } else {
                showNotification('‚ùå ' + result.error, 'error');
            }
        }
        
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdownMenu');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function closeUserDropdown() {
            document.getElementById('userDropdownMenu').style.display = 'none';
        }
        
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userDropdownMenu');
            const avatar = document.querySelector('.user-avatar');
            
            if (dropdown && avatar && !avatar.contains(event.target) && !dropdown.contains(event.target)) {
                closeUserDropdown();
            }
        });
        
        // ============================================================================
        // DESIGN MANAGEMENT HANDLERS
        // ============================================================================
        
        function openSaveDesignModal() {
            const user = window.SupabaseAuth.getCurrentUser();
            
            if (!user) {
                openAuthModal('signin');
                showNotification('Please sign in to save designs', 'error');
                return;
            }
            
            if (!window.SupabaseAuth.canSaveDesign()) {
                showUpgradeModal();
                return;
            }
            
            const date = new Date().toLocaleDateString();
            document.getElementById('designName').value = `Design ${date}`;
            
            document.getElementById('saveDesignModal').style.display = 'flex';
        }
        
        function closeSaveDesignModal() {
            document.getElementById('saveDesignModal').style.display = 'none';
            document.getElementById('saveDesignStatus').className = 'form-status';
            document.getElementById('saveDesignStatus').textContent = '';
        }
        
        async function handleSaveDesign(event) {
            event.preventDefault();
            
            const name = document.getElementById('designName').value;
            const statusDiv = document.getElementById('saveDesignStatus');
            
            if (!pinSequence || pinSequence.length === 0) {
                statusDiv.className = 'form-status error';
                statusDiv.textContent = 'No design to save. Generate a design first!';
                return;
            }
            
            const canvasImage = canvas.toDataURL('image/png');
            
            const threadThickness = parseFloat(document.getElementById('threadThickness').value);
            const circleRadius = parseFloat(document.getElementById('circleRadius').value);
            
            const designData = {
                name: name,
                imageData: currentImageData,
                canvasImage: canvasImage,
                parameters: {
                    num_nails: numNails,
                    num_strings: pinSequence.length - 1,
                    circle_radius_cm: circleRadius,
                    thread_thickness_mm: threadThickness,
                    image_resolution: parseInt(document.getElementById('imageResolution').value)
                },
                sequence: pinSequence,
                patternInfo: {
                    total_length_m: parseFloat(document.getElementById('stringLength').textContent.split(' ')[0]),
                    num_lines: parseInt(document.getElementById('linesGenerated').textContent),
                    provider: lastGenerationProvider || 'unknown',
                    generation_time_ms: lastGenerationTime || 0
                }
            };
            
            statusDiv.className = 'form-status';
            statusDiv.textContent = 'Saving...';
            
            const result = await window.SupabaseAuth.saveDesign(designData);
            
            if (result.success) {
                statusDiv.className = 'form-status success';
                statusDiv.textContent = '‚úÖ Design saved successfully!';
                
                setTimeout(() => {
                    closeSaveDesignModal();
                    showNotification('üíæ Design saved!', 'success');
                }, 1500);
            } else if (result.needsUpgrade) {
                closeSaveDesignModal();
                showUpgradeModal();
            } else {
                statusDiv.className = 'form-status error';
                statusDiv.textContent = '‚ùå ' + result.error;
            }
        }
        
        async function openMyDesignsModal() {
            const user = window.SupabaseAuth.getCurrentUser();
            
            if (!user) {
                openAuthModal('signin');
                showNotification('Please sign in to view your designs', 'error');
                return;
            }
            
            document.getElementById('myDesignsModal').style.display = 'flex';
            
            const grid = document.getElementById('designsGrid');
            grid.innerHTML = '<p style="text-align: center; padding: 40px;">Loading...</p>';
            
            const designs = await window.SupabaseAuth.loadUserDesigns();
            renderDesignsGrid(designs);
            
            const profile = window.SupabaseAuth.getUserProfile();
            if (profile && !window.SupabaseAuth.isProUser()) {
                document.getElementById('designsLimitInfo').style.display = 'flex';
                document.getElementById('designCount').textContent = profile.design_count;
            } else {
                document.getElementById('designsLimitInfo').style.display = 'none';
            }
        }
        
        function closeMyDesignsModal() {
            document.getElementById('myDesignsModal').style.display = 'none';
        }
        
        function renderDesignsGrid(designs) {
            const grid = document.getElementById('designsGrid');
            const noDesigns = document.getElementById('noDesigns');
            
            if (!designs || designs.length === 0) {
                grid.style.display = 'none';
                noDesigns.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            noDesigns.style.display = 'none';
            
            grid.innerHTML = designs.map(design => `
                <div class="design-card">
                    <img src="${design.canvas_image}" alt="${design.name}" class="design-card-image" 
                         onclick="loadDesignById('${design.id}')">
                    <div class="design-card-content">
                        <h3 class="design-card-name">${design.name}</h3>
                        <p class="design-card-info">üìÖ ${new Date(design.created_at).toLocaleDateString()}</p>
                        <p class="design-card-info">üé® ${design.pattern_info.num_lines} lines</p>
                        <p class="design-card-info">üìè ${design.pattern_info.total_length_m.toFixed(1)}m string</p>
                        <div class="design-card-actions">
                            <button class="btn-small" onclick="loadDesignById('${design.id}')">Load</button>
                            <button class="btn-small danger" onclick="confirmDeleteDesign('${design.id}', '${design.name}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function loadDesignById(designId) {
            const result = await window.SupabaseAuth.loadDesign(designId);
            
            if (!result.success) {
                showNotification('‚ùå ' + result.error, 'error');
                return;
            }
            
            const design = result.data;
            
            currentImageData = design.image_data;
            const img = new Image();
            img.onload = function() {
                sourceCtx.clearRect(0, 0, sourceCanvas.width, sourceCanvas.height);
                sourceCtx.drawImage(img, 0, 0, sourceCanvas.width, sourceCanvas.height);
                switchTab('source');
            };
            img.src = design.image_data;
            
            document.getElementById('numNails').value = design.parameters.num_nails;
            document.getElementById('numNailsValue').textContent = design.parameters.num_nails;
            document.getElementById('numStrings').value = design.parameters.num_strings;
            document.getElementById('numStringsValue').textContent = design.parameters.num_strings;
            document.getElementById('circleRadius').value = design.parameters.circle_radius_cm;
            document.getElementById('circleRadiusValue').textContent = design.parameters.circle_radius_cm;
            document.getElementById('threadThickness').value = design.parameters.thread_thickness_mm;
            document.getElementById('threadThicknessValue').textContent = design.parameters.thread_thickness_mm;
            document.getElementById('imageResolution').value = design.parameters.image_resolution;
            document.getElementById('imageResolutionValue').textContent = design.parameters.image_resolution;
            
            pinSequence = design.sequence;
            numNails = design.parameters.num_nails;
            circleRadius = design.parameters.circle_radius_cm;
            
            animateDrawing(pinSequence, numNails);
            
            document.getElementById('stringLength').textContent = `${design.pattern_info.total_length_m.toFixed(2)} m (approx ${(design.pattern_info.total_length_m * 3.28084).toFixed(1)} ft)`;
            document.getElementById('linesGenerated').textContent = design.pattern_info.num_lines;
            infoBox.style.display = 'block';
            
            replayBtn.disabled = false;
            voicePlay.disabled = false;
            voiceStop.disabled = false;
            downloadTemplateBtn.disabled = false;
            
            closeMyDesignsModal();
            showNotification('‚úÖ Design loaded: ' + design.name, 'success');
        }
        
        function confirmDeleteDesign(designId, designName) {
            if (confirm(`Are you sure you want to delete "${designName}"? This cannot be undone.`)) {
                deleteDesignById(designId);
            }
        }
        
        async function deleteDesignById(designId) {
            const result = await window.SupabaseAuth.deleteDesign(designId);
            
            if (result.success) {
                showNotification('üóëÔ∏è Design deleted', 'success');
                
                const designs = await window.SupabaseAuth.loadUserDesigns();
                renderDesignsGrid(designs);
                
                const profile = window.SupabaseAuth.getUserProfile();
                if (profile && !window.SupabaseAuth.isProUser()) {
                    document.getElementById('designCount').textContent = profile.design_count;
                }
            } else {
                showNotification('‚ùå ' + result.error, 'error');
            }
        }
        
        function showUpgradeModal() {
            document.getElementById('upgradeModal').style.display = 'flex';
        }
        
        function closeUpgradeModal() {
            document.getElementById('upgradeModal').style.display = 'none';
        }
        
        function handleUpgrade() {
            alert('Stripe integration coming soon! For now, contact support to upgrade.');
        }
        
        // ============================================================================
        // UI UPDATE HANDLERS
        // ============================================================================
        
        window.addEventListener('userLoggedIn', function(event) {
            const { user, profile } = event.detail;
            
            document.getElementById('userMenuLoggedOut').style.display = 'none';
            document.getElementById('userMenuLoggedIn').style.display = 'flex';
            
            document.getElementById('saveDesignBtn').style.display = 'inline-block';
            document.getElementById('loadDesignBtn').style.display = 'inline-block';
            
            if (user.email) {
                document.getElementById('userEmail').textContent = user.email;
                
                const name = profile?.full_name || user.email;
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                document.getElementById('userInitials').textContent = initials;
            }
            
            if (profile) {
                document.getElementById('userName').textContent = profile.full_name || 'User';
                
                const isPro = window.SupabaseAuth.isProUser();
                document.getElementById('userPlan').textContent = isPro ? 'Pro Plan ‚≠ê' : 'Free Plan';
            }
        });
        
        window.addEventListener('userLoggedOut', function() {
            document.getElementById('userMenuLoggedOut').style.display = 'flex';
            document.getElementById('userMenuLoggedIn').style.display = 'none';
            
            document.getElementById('saveDesignBtn').style.display = 'none';
            document.getElementById('loadDesignBtn').style.display = 'none';
            
            closeUserDropdown();
        });
        
        // ============================================================================
        // NOTIFICATION SYSTEM
        // ============================================================================
        
        function showNotification(message, type = 'info') {
            let container = document.getElementById('notificationContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notificationContainer';
                container.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                `;
                document.body.appendChild(container);
            }
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                padding: 16px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                min-width: 250px;
                animation: slideIn 0.3s ease;
            `;
            
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            } else if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)';
            } else {
                notification.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
            }
            
            notification.textContent = message;
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 4000);
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>